# networking

## Basics

to see the links of each host
```bash
ip link

# to assign the address
ip addr add 192.168.1.10/24 dev eth0

# to get the routing table
route

# how to set a gateway?
# here we are directly adding information in the routing
ip route add 192.168.2.0/24 via 192.168.1.1

# for reverse
ip route add 192.168.1.0/24 via 192.168.2.1
# here we specificed the network address which can be reached via the specific ip

# for the router to internet
ip route add 172.23.42.0/24 via 192.168.2.1


# else better solution
ip route add default via 192.168.2.1

# to persist all these
#add to the /etc/network/interfaces file
```

the default or 0.0.0.0 in the destination means the same in routing table

when the gateway is  0.0.0.0 means the we dont need a gateway to access its local subnet / network

> by default in linux packets are not forwarded from one interface to another

for security so `eth0` cannot forward packet to `eth1`

so whether a system is allowed to forward the ip packets is govered by
```bash
# does not persist
cat /proc/sys/net/ipv4/ip_forward

# to persist
vi /etc/sysctl.conf
# and add
net.ipv4.ip_forward = 1
```

for dns
```bash
/etc/hosts

192.168.1.11 db
```

so to avoid to many manual addition we can move these things to a seperate dns server which keeps all these records

```bash
# to make a particular resolver for dns we can
cat /etc/resolv.conf
nameserver ...
```

we can change the resolver `files to dns`

```bash
cat /etc/nsswitch.conf
hosts: files dns
# to
hosts: dns files
```

to options if not found 
1. add 8.8.8.8 to resolv
2. add `Forward All to 8.8.8.8` in the dns server

if the /etc/hosts contains
```
ADDRESS   web.sajcn.com
ADDRESS   sxa.sajcn.com
```

for each time we need to write the full dns name even in the local network
we can use instead
```
# /etc/resolv.conf
nameserver 192..e.

search sajcn.com prod.sajcn.com
```

now if we do `ping web` it resolves


> nslookup does not take the entries in the local system


we can use coredns to run our local dns server

before running we need to change the /etc/hosts and also Corefile
```
. {
  hosts /etc/hosts
}
```

```bash
./coredns
```

## Network namespaces

```bash
# to create a networks ns
ip netns add red
ip netns add blue

ip netns

ip link

# so to view in the network ns
ip netns exec red ip link
# or
ip -n red link

# same with arp as well
ip netns exec red arp

# same for route

```

for linking 2 namespaces
```bash
ip netns add red
ip netns add blue


ip link add veth-red type veth peer name veth-blue

# move the interface to respective ns
ip link set veth-red netns red
ip link set veth-blue netns blue

# set the address
ip netns exec red ip addr add 192.168.15.1/24 dev veth-red
ip netns exec blue ip addr add 192.168.15.2/24 dev veth-blue

# no shutdown
ip netns exec red ip link set veth-red up
ip netns exec blue ip link set veth-blue up


# for ping
ip netns exec red ping 192.168.15.2

# for delete link

ip -n red link del veth-red
```

for multiple ns we can create the linux bridge
```bash
ip link add v-net-0 type bridge

ip link set dev v-net-0 up

#it act as virtual switch

ip link add veth-red type veth peer name veth-red-br
ip link add veth-blue type veth peer name veth-blue-br

ip link set veth-red netns red
ip link set veth-blue netns blue

ip link set veth-red-br master v-net-0
ip link set veth-blue-br master v-net-0

ip -n red addr add 192.168.15.1/24 dev veth-red
ip -n blue addr add 192.168.15.2/24 dev veth-blue

ip netns exec red link set veth-red up
ip netns exec blue link set veth-blue up
```

to make the host connect to the ns
```bash
ip addr add 192.168.15.5/24 dev v-net-0
```

how to make it connected to the eth0
 and to another host via lan

then you try to add route to the routing
```bash
# as the interfaces are in local system
ip netns exec blue ip route add 192.168.1.0/24 via 192.168.15.5
# as showin in the image
# but still we cannot reach it destination

# so we need to enable NAT so that it can take these requests and sends it through the default gateway

# need NAT
iptables -t nat -A POSTROUTING -s 192.168.15.0/24 -j MASQUERADE
```
> MASQUERADE -> replace the from address from the packets from source network with its own ip address

lets now we need to ping 8.8.8.8

```bash
ip netns exec blue route # will show no route to the address
# we can do is add route to default gateway
ip netns exec blue ip route add default via 192.168.15.5
```

lets say we wanr to access the namespace fromthe other host
we failed their 2 solutions

1. make a ip table routing add to the host
2. iptable portforwarding rule

this is the port-forwatding
```bash
iptables -t nat -A PREROUTING --dport 80 --to-destination 192.168.15.2:80 -j DNAT
```


# FAQ
While testing the Network Namespaces, if you come across issues where you canâ€™t ping one namespace from the other, make sure you set the NETMASK while setting IP Address. ie: 192.168.1.10/24

```bash
ip -n red addr add 192.168.1.10/24 dev veth-red
```
Another thing to check is FirewallD/IP Table rules. Either add rules to IP Tables to allow traffic from one namespace to another. Or disable IP Tables all together (Only in a learning environment).

```bash
sudo iptables -nvL -t nat
```

```
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
  420 14329 DOCKER     0    --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 DOCKER     0    --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    4   240 MASQUERADE  0    --  *      !docker0  172.17.0.0/16        0.0.0.0/0

Chain DOCKER (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     0    --  docker0 *       0.0.0.0/0            0.0.0.0/0
```

# CNI

supported plugins
- bridge
- vlan
- ipvlan
- macvlan
- windows
- dhcp
- host-local


other 3rd party CNI
- weaveworks
- flannel
- cilium
...

> docker does not do CNI but a CNM due to which kubernetes has to first run it in `--network=none` and then do `bridge add dcs34e /var/run/netns/dcs34e`

> https://kubernetes.io/docs/reference/networking/ports-and-protocols/
> also check the pictures

```bash
netstat -plnt
```


If you were to ping google from the controlplane node, which route does it take?
What is the IP address of the Default Gateway?
```bash
ip route show default
```

> Correct! That's because 2379 is the port of ETCD to which all control plane components connect to. 2380 is only for etcd peer-to-peer connectivity. When you have multiple controlplane nodes. In this case we don't.

to get all the bridge interfaces
```bash
ip address show type bridge
```


----

what happens is CRI after done creating the ersources ask the CNI to configure for the network by calling the approproxxate plugin
view the kubelet options
```bash
ps -aux | grep kubelet

ls /opt/cni/bin # check the `--cni-bin-dir=`

ls /etc/cni/net.d # this represents the plugin to use
#if in this directory multiple files are their then it chooses the one in alphabitical order
```

```conf
// /etc/cni/net.d/10-bridge.conf

{
  "cniVersion": "13.0",
  ...
  "isGateway": true,
  "ipMasq": true,
  "ipam": {
    "type": "host-local",
    "subnet": "10.22.0.0/16",
    "routes": [
      {"dst": "0.0.0.0/0"}
    ]
  }
}
```

> isGateway defines whether the bridge network interface shoud get an IP address assigned so it can act as a gateway.
> ipMasquerade deines is a NAT rules should be added for IP masquerading.
> IPAM section defines IPAM confis, this is where you specifcy the subnet or the range of IP addresses that will be assigned to pods and any necessary routes. the typical host-local indicates that the IP address are managed locally on this host. unlike a DHCP server maintaining it remotly. the type can also be set to DHCP to configur and external DHCP server


